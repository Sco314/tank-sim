<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Interactive Tank & Valve Simulator</title>
<style>
  :root{
    --bg:#0b1020;
    --card:#121a33;
    --ink:#e9f0ff;
    --muted:#9bb0ff;
    --accent:#7cc8ff;
    --ok:#3ddc97;
    --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:500 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
    color:var(--ink); background:radial-gradient(1200px 800px at 80% -10%, #1b2752 0%, var(--bg) 60%);
    display:grid; place-items:center; padding:18px;
  }
  .app{width:min(1100px,95vw);}
  .grid{display:grid; grid-template-columns: 1.2fr 1fr; gap:18px}
  .card{background:var(--card); border:1px solid #1f2a50; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1{font-size:20px; margin:0 0 8px}
  .sub{color:var(--muted); font-size:13px}
  button, input[type=range]{accent-color:var(--accent)}
  .controls{display:grid; gap:14px}
  .row{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .row .grow{flex:1}
  .btn{background:#172144; color:var(--ink); border:1px solid #28366d; padding:10px 14px; border-radius:12px; cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.toggle[aria-pressed="true"]{background:#0e2e1f; border-color:#1d6f4b; color:#d6ffee}
  .kv{display:grid; grid-template-columns:auto 1fr; gap:6px 10px; font-variant-numeric:tabular-nums}
  .kv div:nth-child(odd){color:var(--muted)}
  .small{font-size:12px; color:var(--muted)}
  .stage{display:flex; align-items:center; justify-content:center}
  svg{width:100%; height:auto; display:block}
  .flow { stroke-dasharray: 10 12; }
  .flow.on { animation: dash var(--duration, 600ms) linear infinite; }
  @keyframes dash { to { stroke-dashoffset: -22; } }
  
  /* Enhanced valve button styling - NO TRANSFORMS, just visual feedback */
  .valve{
    cursor: pointer;
    transform: none !important; /* Force no transform on hover */
  }
  .valve:hover, .valve:active, .valve:focus {
    transform: none !important; /* Absolutely no transforms */
  }
  .valve .valve-bg{
    transition: opacity 0.2s ease, stroke-width 0.2s ease;
  }
  .valve:hover .valve-bg{
    opacity: 1 !important;
    stroke-width: 3;
  }
  .valve:active .valve-bg{
    fill: #2a3f7a !important;
  }
  
  .levelRect{ transition: height 120ms linear, y 120ms linear; }
  .warn{color:var(--danger)}
</style>
</head>
<body>
  <!-- TEST BUTTON - Remove after testing -->
  <button onclick="testPopup()" style="position:fixed;top:10px;right:10px;z-index:9999;padding:10px;background:red;color:white;border:2px solid white;border-radius:8px;font-weight:bold;cursor:pointer;">TEST POPUP</button>

  <div class="app">
    <div class="grid">
      <!-- LEFT: Visualization -->
      <div class="card stage">
        <svg viewBox="0 0 1000 600" aria-labelledby="title desc" role="img">
          <title id="title">Tank and Pipe Visualization</title>
          <desc id="desc">Click the inlet valve to open interactive valve control. Use the slider to adjust outlet flow. The blue rectangle shows the liquid level.</desc>
          <defs>
            <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
              <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#22305f" stroke-width="1" />
            </pattern>
            <linearGradient id="liquid" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#7cc8ff"/>
              <stop offset="100%" stop-color="#2d8bd6"/>
            </linearGradient>
          </defs>
          <rect x="0" y="0" width="1000" height="600" fill="url(#grid)" opacity="0.4"/>
          <g id="inlet">
            <path d="M 80 200 H 360 V 260 H 540" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"/>
            <path id="inletFlow" class="flow" d="M 80 200 H 360 M 360 260 H 540" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" stroke-dashoffset="0" />
          </g>
          
          <!-- VALVE: Positioned at midpoint of left horizontal pipe (x=220, y=230) -->
          <g id="valve" class="valve" tabindex="0" role="button" aria-pressed="false" aria-label="Open valve control">
            <!-- Position transform applied here -->
            <g transform="translate(220, 230)">
              <!-- Large invisible hitbox for easier clicking (100x100px centered) -->
              <rect class="valve-hitbox" x="-50" y="-50" width="100" height="100" fill="transparent" stroke="none"/>
              
              <!-- Visual background with highlight -->
              <rect class="valve-bg" x="-28" y="-28" width="56" height="56" rx="12" fill="#1c2a55" stroke="#3ddc97" stroke-width="2" opacity="0.6"/>
              
              <!-- Valve body -->
              <rect x="-24" y="-24" width="48" height="48" rx="8" fill="#1c2a55" stroke="#2e3f7a" stroke-width="2"/>
              
              <!-- Handle that rotates -->
              <g id="handle" transform="rotate(0)" pointer-events="none">
                <circle cx="0" cy="0" r="8" fill="#e9f0ff" />
                <rect x="-6" y="-48" width="12" height="32" rx="4" fill="#3ddc97"/>
              </g>
              
              <!-- Label below valve -->
              <text x="0" y="70" fill="#9bb0ff" font-size="13" text-anchor="middle" font-weight="600" pointer-events="none">Inlet Valve</text>
              <text x="0" y="85" fill="#7cc8ff" font-size="10" text-anchor="middle" pointer-events="none">(click to control)</text>
            </g>
          </g>
          
          <g id="tank" transform="translate(560, 120)">
            <rect x="0" y="0" width="320" height="360" rx="18" fill="#0e1734" stroke="#2a3d78" stroke-width="4"/>
            <rect id="levelRect" class="levelRect" x="6" y="360" width="308" height="0" fill="url(#liquid)"/>
            <g id="ticks" stroke="#334a90">
              <path d="M0 60 h-14 M0 120 h-14 M0 180 h-14 M0 240 h-14 M0 300 h-14"/>
              <text x="-20" y="66" text-anchor="end" fill="#9bb0ff" font-size="12">80%</text>
              <text x="-20" y="126" text-anchor="end" fill="#9bb0ff" font-size="12">60%</text>
              <text x="-20" y="186" text-anchor="end" fill="#9bb0ff" font-size="12">40%</text>
              <text x="-20" y="246" text-anchor="end" fill="#9bb0ff" font-size="12">20%</text>
              <text x="-20" y="306" text-anchor="end" fill="#9bb0ff" font-size="12">0%</text>
            </g>
          </g>
          <g id="outlet">
            <path d="M 720 480 H 940" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"/>
            <path id="outletFlow" class="flow" d="M 720 480 H 940" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" />
          </g>
          
          <!-- REMOVED: Redundant readouts text - data is shown in the right panel -->
        </svg>
      </div>

      <!-- RIGHT: Controls & Telemetry -->
      <div class="card">
        <h1>Controls</h1>
        <div class="sub">Click the green valve in the visualization to open the interactive valve control. Use the button below for quick on/off toggle. Adjust outlet flow to drain the tank. Physics uses a simple mass balance dV/dt = Qin − Qout with a fixed cross-section area.</div>
        <div class="controls" style="margin-top:12px">
          <div class="row">
            <button id="toggleValve" class="btn toggle" aria-pressed="false">Open Inlet Valve</button>
            <button id="resetBtn" class="btn">Reset</button>
            <button id="pauseBtn" class="btn" aria-pressed="false">Pause</button>
          </div>
          <div class="row">
            <label for="qout" style="min-width:128px">Outlet flow</label>
            <input id="qout" class="grow" type="range" min="0" max="1.2" step="0.01" value="0.35" />
            <output id="qoutVal" style="width:64px; text-align:right">0.35</output>
          </div>
          <div class="row">
            <label for="qin" style="min-width:128px">Inlet flow (max)</label>
            <input id="qin" class="grow" type="range" min="0" max="1.5" step="0.01" value="0.80" />
            <output id="qinVal" style="width:64px; text-align:right">0.80</output>
          </div>
          <div class="row">
            <label for="area" style="min-width:128px">Tank area</label>
            <input id="area" class="grow" type="range" min="0.5" max="3" step="0.01" value="1.20" />
            <output id="areaVal" style="width:64px; text-align:right">1.20</output>
          </div>
          <div class="kv" style="margin-top:10px">
            <div>Simulation step</div><div><span id="dtMs">16.7</span> ms (dynamic)</div>
            <div>Tank height (max)</div><div>360 px visual (normalized 1.0)</div>
            <div>Overflow limit</div><div id="overflowText">100%</div>
          </div>
          <p class="small" style="margin:8px 0 0">Tip: For a head-dependent drain, enable "Gravity mode" below. Then Qout = k·√(level). The slider sets k.</p>
          <div class="row">
            <label><input type="checkbox" id="gravityMode" /> Gravity mode</label>
            <input id="kcoeff" class="grow" type="range" min="0" max="1.5" step="0.01" value="0.60" />
            <output id="kVal" style="width:64px; text-align:right">0.60</output>
          </div>
        </div>
        <hr style="border-color:#22305f; opacity:.5; margin:14px 0">
        <h1>Readouts</h1>
        <div class="kv">
          <div>Level</div><div><span id="levelPct">0.0</span>%</div>
          <div>Volume</div><div><span id="vol">0.000</span> units</div>
          <div>Qin</div><div><span id="qinRead">0.00</span> units/s</div>
          <div>Qout</div><div><span id="qoutRead">0.00</span> units/s</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load organized JavaScript -->
  <script src="js/ValvePopup.js"></script>
  <script src="js/TankSimulation.js"></script>
  
  <!-- Test popup function -->
  <script>
  function testPopup() {
    console.log('Test button clicked');
    if (window.simulation && window.simulation.valvePopup) {
      console.log('Using simulation popup...');
      window.simulation._openValvePopup();
    } else if (window.ValvePopup) {
      console.log('ValvePopup found, creating new instance...');
      const popup = new ValvePopup((value) => console.log('Valve value:', value));
      popup.open(0.5);
    } else {
      console.error('ValvePopup not loaded!');
      alert('ValvePopup.js failed to load. Check the console for errors.');
    }
  }
  </script>
</body>
</html>
