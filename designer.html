<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Process Simulator Designer v3.2</title>
  <link rel="stylesheet" href="css/designer-style.css">
</head>
<body>

<!-- Hidden SVG sprite container -->
<svg style="display:none" aria-hidden="true">
  <defs id="component-sprite">
    <!-- Symbols will be populated by designer.js -->
  </defs>
</svg>

<div class="designer-container">
  
  <!-- Left Sidebar: Component Library -->
  <aside class="library-panel">
    <div class="library-header">
      <h2>Components</h2>
      <input
        type="text"
        id="searchComponents"
        placeholder="Search components..."
        class="search-input"
      >
    </div>
    <div class="library-content" id="componentPalette">
      <!-- Populated by designer.js with Feed/Product dropdowns -->
    </div>
  </aside>

  <!-- Main Canvas Area -->
  <main class="canvas-area">
    <div class="toolbar">
      <div class="toolbar-section">
        <button id="selectTool" class="tool-btn active" title="Select Tool">
          <span>🖱️</span> Select
        </button>
        <button id="connectTool" class="tool-btn" title="Connect Tool">
          <span>🔗</span> Connect
        </button>
      </div>
      
      <div class="toolbar-section">
        <label class="toolbar-option">
          <input type="checkbox" id="gridToggle" checked>
          <span>Grid</span>
        </label>
        <label class="toolbar-option">
          <input type="checkbox" id="snapToggle" checked>
          <span>Snap</span>
        </label>
      </div>

      <div class="toolbar-section">
        <button id="previewBtn" class="btn" title="Preview Design">
          👁️ Preview
        </button>
        <button id="importBtn" class="btn" title="Import Design">
          📥 Import
        </button>
        <button id="saveDesignBtn" class="btn" title="Save Design as JSON">
          💾 Save Design
        </button>
      </div>

      <div class="toolbar-section">
        <button id="clearBtn" class="btn btn-warning" title="Clear Canvas">
          🗑️ Clear
        </button>

        <!-- ✅ NEW: Direct export button with progress tracking -->
        <button id="btn-export" class="btn btn-primary" title="Export Simulator with Progress">
          📤 Export Sim
        </button>

        <button id="exportSingleFile" class="btn btn-primary" title="Export Single-File HTML">
          📄 Single-File
        </button>

        <button id="exportZip" class="btn" title="Export Flat Folder / ZIP">
          📦 ZIP
        </button>
      </div>

      <div class="toolbar-stats">
        <span id="componentCount">Components: 0</span>
        <span id="connectionCount">Connections: 0</span>
        <span id="mousePos">X: 0, Y: 0</span>
        <!-- ✅ NEW: Export status display -->
        <span id="export-status" style="font:12px/1.4 system-ui;color:#6b7280;margin-left:10px"></span>
      </div>
    </div>

    <div class="canvas-wrapper">
      <svg 
        id="canvas" 
        viewBox="0 0 1000 600" 
        xmlns="http://www.w3.org/2000/svg"
        class="design-canvas"
      >
        <defs>
          <pattern id="designerGrid" width="20" height="20" patternUnits="userSpaceOnUse">
            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#22305f" stroke-width="1"/>
          </pattern>
        </defs>
        
        <rect 
          id="gridRect" 
          x="0" 
          y="0" 
          width="100%" 
          height="100%" 
          fill="url(#designerGrid)"
          opacity="0.4"
        />
        
        <g id="connectionsLayer"></g>
        <g id="componentsLayer"></g>
      </svg>
    </div>
  </main>

  <!-- Right Sidebar: Properties -->
  <aside class="properties-panel">
    <div class="properties-header">
      <h2>Properties</h2>
    </div>
    <div class="properties-content" id="propertiesContent">
      <div class="empty-state">
        <div class="empty-icon">📋</div>
        <p>Select a component to edit its properties</p>
      </div>
    </div>
  </aside>

</div>

<!-- Export Modal (kept for compatibility with existing code) -->
<div id="exportModal" class="modal-overlay" style="display: none;" aria-hidden="true">
  <div class="modal-container">
    <button
      id="exportModalClose"
      class="modal-close"
      aria-label="Close export dialog"
    >
      ×
    </button>

    <div class="modal-header">
      <h2>📤 Export Simulator</h2>
    </div>

    <div class="modal-body">
      <div class="export-info">
        <div class="info-row">
          <span>Components:</span>
          <strong id="compCount">0</strong>
        </div>
        <div class="info-row">
          <span>Connections:</span>
          <strong id="connCount">0</strong>
        </div>
      </div>

      <div class="form-field">
        <label for="simName">Simulator Name:</label>
        <input
          type="text"
          id="simName"
          placeholder="My Process Simulator"
          value="My Simulator"
          class="text-input"
        >
      </div>

      <div class="export-note">
        <strong>📝 Note:</strong>
        <p>Exports standalone HTML file with all engine code embedded from GitHub.</p>
      </div>
    </div>

    <div class="modal-footer">
      <button id="exportCancelBtn" class="btn">Cancel</button>
      <button id="exportConfirmBtn" class="btn btn-primary">Export</button>
    </div>
  </div>
</div>


<!-- Scripts -->
<!-- JSZip for ZIP export support -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- Load scripts in correct order with cache-busting -->
<script src="js/componentLibrary.js?v=3.2"></script>
<script src="js/exporter.js?v=5.5"></script>
<script src="js/designer.js?v=3.2"></script>

<!-- ✅ NEW: Export button handler with progress tracking -->
<script>
  // Wait for designer to be ready
  window.addEventListener('DOMContentLoaded', () => {
    const statusEl = document.getElementById('export-status');
    
    // Progress tracking object
    const progress = {
      update: (msg) => {
        if (statusEl) statusEl.textContent = msg;
        console.log('📊 Export progress:', msg);
      },
      setDetail: (d) => {
        if (statusEl) statusEl.textContent = (statusEl.textContent || '') + ' — ' + d;
        console.log('📊 Export detail:', d);
      }
    };

    // Export button handler
    const exportBtn = document.getElementById('btn-export');
    if (exportBtn) {
      exportBtn.addEventListener('click', async () => {
        try {
          // Clear previous status
          if (statusEl) statusEl.textContent = '⏳ Starting export...';
          
          // Get designer instance (set by designer.js)
          const designer = window.designer || window.DESIGNER;
          
          if (!designer) {
            throw new Error('Designer not initialized. Please wait for page to load.');
          }
          
          // Check if we have components
          if (!designer.components || designer.components.size === 0) {
            throw new Error('No components on canvas. Add components before exporting.');
          }
          
          // Create exporter instance
          const exporter = new SimulatorExporter(designer, {
            baseUrl: 'https://sco314.github.io/tank-sim/' // GitHub Pages root
          });
          
          // Export with progress tracking
          progress.update('⏳ Fetching engine files...');
          const html = await exporter.exportSimulator(progress);
          
          // Download the file
          progress.update('⏳ Downloading...');
          const simName = 'simulator'; // You can make this configurable
          const filename = simName.toLowerCase().replace(/[^a-z0-9]+/g, '-') + '.html';
          download(filename, html, 'text/html');
          
          // Success!
          if (statusEl) {
            statusEl.textContent = '✅ Exported successfully!';
            statusEl.style.color = '#10b981';
          }
          
          // Clear status after 3 seconds
          setTimeout(() => {
            if (statusEl) {
              statusEl.textContent = '';
              statusEl.style.color = '#6b7280';
            }
          }, 3000);
          
        } catch (e) {
          console.error('❌ Export failed:', e);
          if (statusEl) {
            statusEl.textContent = '💥 Export failed: ' + e.message;
            statusEl.style.color = '#ef4444';
          }
          alert('Export failed: ' + e.message);
        }
      });
      
      console.log('✅ New export button handler initialized');
    }

    // Save Design button
    const saveDesignBtn = document.getElementById('saveDesignBtn');
    if (saveDesignBtn) {
      saveDesignBtn.addEventListener('click', () => {
        const designer = window.designer;
        if (!designer) return;
        
        const design = designer.getDesignData();
        const json = JSON.stringify(design, null, 2);
        download('design.json', json, 'application/json');
      });
    }

    // Import button
    const importBtn = document.getElementById('importBtn');
    if (importBtn) {
      importBtn.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const design = JSON.parse(e.target.result);
              window.designer.loadDesign(design);
            } catch (err) {
              alert('Failed to load design: ' + err.message);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      });
    }
  });

  /**
   * Download helper function
   */
  function download(filename, text, mime) {
    const blob = new Blob([text], { type: mime || 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  }
</script>


</body>
</html>
