<!DOCTYPE html>
<html lang="en">
<head>
  <title>My Simulator - Process Simulator</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="../../engine/style.css">

  <!-- Core Architecture -->
  <script src="../../engine/core/Component.js" defer></script>
  <script src="../../engine/core/FlowNetwork.js" defer></script>
  <script src="../../engine/core/ComponentManager.js" defer></script>

  <!-- Boundary Components -->
  <script src="../../engine/components/sources/Feed.js" defer></script>
  <script src="../../engine/components/sinks/Drain.js" defer></script>

  <!-- Tank Components -->
  <script src="../../engine/components/tanks/Tank.js" defer></script>

  <!-- Pump Components -->
  <script src="../../engine/components/pumps/Pump.js" defer></script>
  <script src="../../engine/components/pumps/FixedSpeedPump.js" defer></script>
  <script src="../../engine/components/pumps/VariableSpeedPump.js" defer></script>
  <script src="../../engine/components/pumps/ThreeSpeedPump.js" defer></script>

  <!-- Valve Components -->
  <script src="../../engine/components/valves/Valve.js" defer></script>

  <!-- Pipe Components -->
  <script src="../../engine/components/pipes/Pipe.js" defer></script>

  <!-- Sensor Components -->
  <script src="../../engine/components/sensors/PressureSensor.js" defer></script>

  <!-- Managers -->
  <script src="../../engine/managers/TankManager.js" defer></script>
  <script src="../../engine/managers/PumpManager.js" defer></script>
  <script src="../../engine/managers/ValveManager.js" defer></script>
  <script src="../../engine/managers/PipeManager.js" defer></script>
  <script src="../../engine/managers/PressureManager.js" defer></script>

  <!-- Configuration -->
  <script src="./systemConfig.js" defer></script>

  <!-- Initialize System -->
  <script defer>
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        console.log('=== INITIALIZING SYSTEM ===');
        
        if (!window.SYSTEM_CONFIG) {
          console.error('❌ SYSTEM_CONFIG not loaded');
          return;
        }
        if (!window.ComponentManager) {
          console.error('❌ ComponentManager not loaded');
          return;
        }
        
        console.log('✅ All components loaded');
        
        window.componentManager = new ComponentManager(SYSTEM_CONFIG);
        window.componentManager.initialize().then(success => {
          if (success) {
            console.log('✅ System initialized successfully');
            window.componentManager.start();
            console.log('✅ Simulation started');
          } else {
            console.error('❌ System initialization failed');
          }
        });
      }, 500);
    });
  </script>
</head>

<body>

<button id="controlsToggle" class="controls-toggle" aria-controls="controlsDrawer" aria-expanded="false">
  Controls
</button>
  
<div class="app">
  <div class="grid">
    <div class="card stage">
      <svg viewBox="0 0 1200 800" aria-labelledby="title desc" role="img">
        <title id="title">My Simulator</title>
        <desc id="desc">Interactive process simulator. Click components to control them.</desc>
        
        <defs>
          <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#22305f" stroke-width="1"></path>
          </pattern>
          <linearGradient id="liquid" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#7cc8ff"></stop>
            <stop offset="100%" stop-color="#2d8bd6"></stop>
          </linearGradient>
        </defs>
        
        <rect x="0" y="0" width="1200" height="800" fill="url(#grid)" opacity="0.4"></rect>
        
        <!-- PIPES (Background Layer) -->
        
        <!-- PIPE: Feed 4 to Control Valve 6 -->
        <g id="pipe1">
          <path d="M 140 160 L 280 160" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
          <path id="pipe1Flow" d="M 140 160 L 280 160" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>
        </g>
        
        <!-- PIPE: Control Valve 6 to Tank 2 -->
        <g id="pipe2">
          <path d="M 280 160 L 440 260" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
          <path id="pipe2Flow" d="M 280 160 L 440 260" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>
        </g>
        
        <!-- PIPE: Feed 3 to Control Valve 7 -->
        <g id="pipe3">
          <path d="M 140 260 L 280 260" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
          <path id="pipe3Flow" d="M 140 260 L 280 260" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>
        </g>
        
        <!-- PIPE: Control Valve 7 to Tank 2 -->
        <g id="pipe4">
          <path d="M 280 260 L 440 260" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
          <path id="pipe4Flow" d="M 280 260 L 440 260" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>
        </g>
        
        <!-- PIPE: Tank 2 to Fixed Speed Pump 5 -->
        <g id="pipe5">
          <path d="M 440 260 L 600 260" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
          <path id="pipe5Flow" d="M 440 260 L 600 260" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>
        </g>
        
        <!-- PIPE: Fixed Speed Pump 5 to Tank 9 -->
        <g id="pipe6">
          <path d="M 600 260 L 760 260" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
          <path id="pipe6Flow" d="M 600 260 L 760 260" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>
        </g>
        
        <!-- PIPE: Feed 8 to Tank 9 -->
        <g id="pipe7">
          <path d="M 740 60 L 760 260" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
          <path id="pipe7Flow" d="M 740 60 L 760 260" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>
        </g>
        
        <!-- PIPE: Tank 9 to Variable Speed Pump 10 -->
        <g id="pipe8">
          <path d="M 760 260 L 920 260" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
          <path id="pipe8Flow" d="M 760 260 L 920 260" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>
        </g>
        
        <!-- PIPE: Variable Speed Pump 10 to Control Valve 12 -->
        <g id="pipe9">
          <path d="M 920 260 L 1040 260" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
          <path id="pipe9Flow" d="M 920 260 L 1040 260" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>
        </g>
        
        <!-- PIPE: Control Valve 12 to Drain 11 -->
        <g id="pipe10">
          <path d="M 1040 260 L 1140 260" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
          <path id="pipe10Flow" d="M 1040 260 L 1140 260" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>
        </g>
        
        <!-- COMPONENTS (Foreground Layer) -->
        
        <!-- TANK: Tank 2 -->
        <g id="comp_1" transform="translate(440, 260)">
          <rect x="-80" y="-90" width="160" height="180" rx="12" fill="#0e1734" stroke="#2a3d78" stroke-width="3"></rect>
          <rect id="comp_1LevelRect" x="-74" y="88" width="148" height="0" fill="url(#liquid)" class="levelRect"></rect>
          <text x="0" y="-100" text-anchor="middle" fill="#9bb0ff" font-size="14">Tank 2</text>
        </g>
        
        <!-- FEED: Feed 3 -->
        <g id="comp_2" transform="translate(140, 260)">
          <circle r="20" fill="#10b98120" stroke="#10b981" stroke-width="2"></circle>
          <text x="0" y="5" text-anchor="middle" font-size="20">⚡</text>
          <text x="0" y="-30" text-anchor="middle" fill="#9bb0ff" font-size="12">Feed 3</text>
        </g>
        
        <!-- FEED: Feed 4 -->
        <g id="comp_3" transform="translate(140, 160)">
          <circle r="20" fill="#10b98120" stroke="#10b981" stroke-width="2"></circle>
          <text x="0" y="5" text-anchor="middle" font-size="20">⚡</text>
          <text x="0" y="-30" text-anchor="middle" fill="#9bb0ff" font-size="12">Feed 4</text>
        </g>
        
        <!-- PUMP: Fixed Speed Pump 5 -->
        <g id="comp_4" class="pump" transform="translate(600, 260)" tabindex="0" role="button" aria-pressed="false" aria-label="Fixed Speed Pump 5">
          <image href="https://sco314.github.io/tank-sim/cent-pump-9-inlet-left.png" x="-60" y="-60" width="120" height="120" />
          <text x="0" y="-70" text-anchor="middle" fill="#9bb0ff" font-size="12">Fixed Speed Pump 5</text>
        </g>
        
        <!-- VALVE: Control Valve 6 -->
        <g id="comp_5" class="valve" tabindex="0" role="button" aria-pressed="false" aria-label="Control Valve 6">
          <g transform="translate(280, 160)">
            <image href="https://sco314.github.io/tank-sim/Valve-Icon-Transparent-bg.png" x="-38" y="-38" width="76" height="76" />
            <text x="0" y="-50" text-anchor="middle" fill="#9bb0ff" font-size="12">Control Valve 6</text>
          </g>
        </g>
        
        <!-- VALVE: Control Valve 7 -->
        <g id="comp_6" class="valve" tabindex="0" role="button" aria-pressed="false" aria-label="Control Valve 7">
          <g transform="translate(280, 260)">
            <image href="https://sco314.github.io/tank-sim/Valve-Icon-Transparent-bg.png" x="-38" y="-38" width="76" height="76" />
            <text x="0" y="-50" text-anchor="middle" fill="#9bb0ff" font-size="12">Control Valve 7</text>
          </g>
        </g>
        
        <!-- FEED: Feed 8 -->
        <g id="comp_7" transform="translate(740, 60)">
          <circle r="20" fill="#10b98120" stroke="#10b981" stroke-width="2"></circle>
          <text x="0" y="5" text-anchor="middle" font-size="20">⚡</text>
          <text x="0" y="-30" text-anchor="middle" fill="#9bb0ff" font-size="12">Feed 8</text>
        </g>
        
        <!-- TANK: Tank 9 -->
        <g id="comp_8" transform="translate(760, 260)">
          <rect x="-80" y="-90" width="160" height="180" rx="12" fill="#0e1734" stroke="#2a3d78" stroke-width="3"></rect>
          <rect id="comp_8LevelRect" x="-74" y="88" width="148" height="0" fill="url(#liquid)" class="levelRect"></rect>
          <text x="0" y="-100" text-anchor="middle" fill="#9bb0ff" font-size="14">Tank 9</text>
        </g>
        
        <!-- PUMP: Variable Speed Pump 10 -->
        <g id="comp_9" class="pump" transform="translate(920, 260)" tabindex="0" role="button" aria-pressed="false" aria-label="Variable Speed Pump 10">
          <image href="https://sco314.github.io/tank-sim/cent-pump-9-inlet-left.png" x="-60" y="-60" width="120" height="120" />
          <text x="0" y="-70" text-anchor="middle" fill="#9bb0ff" font-size="12">Variable Speed Pump 10</text>
        </g>
        
        <!-- DRAIN: Drain 11 -->
        <g id="comp_10" transform="translate(1140, 260)">
          <circle r="20" fill="#ef444420" stroke="#ef4444" stroke-width="2"></circle>
          <text x="0" y="5" text-anchor="middle" font-size="20">⬇️</text>
          <text x="0" y="-30" text-anchor="middle" fill="#9bb0ff" font-size="12">Drain 11</text>
        </g>
        
        <!-- VALVE: Control Valve 12 -->
        <g id="comp_11" class="valve" tabindex="0" role="button" aria-pressed="false" aria-label="Control Valve 12">
          <g transform="translate(1040, 260)">
            <image href="https://sco314.github.io/tank-sim/Valve-Icon-Transparent-bg.png" x="-38" y="-38" width="76" height="76" />
            <text x="0" y="-50" text-anchor="middle" fill="#9bb0ff" font-size="12">Control Valve 12</text>
          </g>
        </g>
      </svg>
    </div>

    <!-- Controls Drawer -->
    <aside id="controlsDrawer" class="controls-drawer" aria-hidden="true">
      <div class="controls-panel card" role="dialog" aria-modal="true" aria-labelledby="controlsTitle">
        <button id="controlsClose" class="controls-close" aria-label="Close controls">×</button>

        <div>
          <h1 id="controlsTitle">System Controls</h1>
          <div class="sub">My Simulator - Click components to interact</div>
          
          <div class="controls">
            <div class="row">
              <button type="button" id="pauseBtn" aria-pressed="false" class="btn">Pause</button>
              <button type="button" id="resetBtn" class="btn">Reset</button>
            </div>
          </div>

          <hr/>
          <h1>System Status</h1>
          <div class="kv" id="systemStatus">
            <div>Status</div><div id="simStatus">Running</div>
          </div>
          
          <hr/>
          <h1>Debug</h1>
          <button type="button" id="debugBtn" class="btn">Show Debug Info</button>
          <pre id="debugOutput" style="display:none; font-size:10px; max-height:200px; overflow:auto; background:#0e1734; padding:8px; margin-top:8px;"></pre>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Controls Drawer Script -->
<script>
(function(){
  const drawer = document.getElementById('controlsDrawer');
  const panel = drawer.querySelector('.controls-panel');
  const toggle = document.getElementById('controlsToggle');
  const closeBtn = document.getElementById('controlsClose');

  function openDrawer(){
    drawer.classList.add('open');
    drawer.setAttribute('aria-hidden','false');
    toggle.setAttribute('aria-expanded','true');
    setTimeout(() => closeBtn.focus(), 0);
  }
  function closeDrawer(){
    drawer.classList.remove('open');
    drawer.setAttribute('aria-hidden','true');
    toggle.setAttribute('aria-expanded','false');
    toggle.focus();
  }

  toggle.addEventListener('click', openDrawer);
  closeBtn.addEventListener('click', closeDrawer);
  drawer.addEventListener('click', (e) => {
    if (!panel.contains(e.target)) closeDrawer();
  });
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && drawer.classList.contains('open')) closeDrawer();
  });
  
  // Pause button
  const pauseBtn = document.getElementById('pauseBtn');
  pauseBtn?.addEventListener('click', () => {
    if (window.componentManager) {
      if (window.componentManager.paused) {
        window.componentManager.resume();
        pauseBtn.textContent = 'Pause';
      } else {
        window.componentManager.pause();
        pauseBtn.textContent = 'Resume';
      }
    }
  });
  
  // Reset button
  const resetBtn = document.getElementById('resetBtn');
  resetBtn?.addEventListener('click', () => {
    if (window.componentManager) {
      window.componentManager.reset();
      console.log('System reset');
    }
  });
  
  // Debug button
  const debugBtn = document.getElementById('debugBtn');
  const debugOutput = document.getElementById('debugOutput');
  debugBtn?.addEventListener('click', () => {
    if (window.componentManager) {
      const info = window.componentManager.getSystemInfo();
      debugOutput.textContent = JSON.stringify(info, null, 2);
      debugOutput.style.display = debugOutput.style.display === 'none' ? 'block' : 'none';
    }
  });
})();
</script>

</body>
</html>