<!DOCTYPE html>
<html lang="en">
<head>
  <title>Interactive Tank & Valve Simulator</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="./style.css">

  <!-- External Scripts -->
  <script src="js/ValvePopup.js" defer></script>
  <script src="js/TankSimulation.js" defer></script>
  <script src="js/uiControls.js" defer></script>
</head>

<body id="id13">

<button id="controlsToggle" class="controls-toggle" aria-controls="controlsDrawer" aria-expanded="false">
  Controls
</button>
  
<div id="ie7wb" class="app">
  <div id="i4pt7" class="grid">
    <div id="i3bwj" class="card stage">
      <svg viewBox="0 0 1000 600" aria-labelledby="title desc" role="img" id="iuele">
        <title id="title">Tank and Pipe Visualization</title>
        <desc id="desc">Click the inlet valve to open interactive valve control. Use the slider to adjust outlet flow. The blue rectangle shows the liquid level.</desc>
        
        <defs id="ic988">
          <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#22305f" stroke-width="1"></path>
          </pattern>
          <linearGradient id="liquid" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#7cc8ff"></stop>
            <stop offset="100%" stop-color="#2d8bd6"></stop>
          </linearGradient>
        </defs>
        
        <rect x="0" y="0" width="1000" height="600" fill="url(#grid)" opacity="0.4"></rect>
        
        <!-- INLET -->
        <g id="inlet">
          <path d="M 80 70 H 380 V 125" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
          <path id="inletFlow" d="M 80 70 H 380 V 125" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>

          <g id="valve" class="valve" tabindex="0" role="button" aria-pressed="false" aria-label="Open valve control">
            <g transform="translate(230, 53)">
              <image href="https://sco314.github.io/tank-sim/Valve-Icon-Transparent-bg.png" x="-38" y="-38" width="76" height="76" />
            </g>
          </g>
        </g>   
        
        <!-- OUTLET -->
        <g id="outlet">
          <path id="outletPipe" d="M 660 460 H 815 V 295 H 960" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round" stroke-linejoin="round"/>
          <path id="outletFlow" d="M 660 460 H 815 V 295 H 960" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" class="flow"/>
        </g>

        <!-- PUMP -->
        <g id="pump" class="pump" transform="translate(790,460)" tabindex="0" role="button" aria-pressed="true" aria-label="Toggle pump">
          <image href="https://sco314.github.io/tank-sim/cent-pump-9-inlet-left.png" x="-20" y="-130" width="230" height="230" />
        </g>

        <!-- OUTLET VALVE -->
        <g id="outletValve" class="valve" tabindex="0" role="button" aria-pressed="true" aria-label="Open outlet valve">
          <g transform="translate(890,278)">
            <image href="https://sco314.github.io/tank-sim/Valve-Icon-Transparent-bg.png" x="-38" y="-38" width="76" height="76" />
          </g>
        </g>
        
        <!-- TANK -->
        <g id="tank" transform="translate(340, 120)">
          <rect x="0" y="0" width="320" height="360" rx="18" fill="#0e1734" stroke="#2a3d78" stroke-width="4"></rect>
          <rect id="levelRect" x="6" y="360" width="308" height="0" fill="url(#liquid)" class="levelRect"></rect>
          <g id="ticks" stroke="#334a90">
            <path d="M0 60 h-14 M0 120 h-14 M0 180 h-14 M0 240 h-14 M0 300 h-14"></path>
            <text x="-20" y="66" text-anchor="end" fill="#9bb0ff" font-size="12">80%</text>
            <text x="-20" y="126" text-anchor="end" fill="#9bb0ff" font-size="12">60%</text>
            <text x="-20" y="186" text-anchor="end" fill="#9bb0ff" font-size="12">40%</text>
            <text x="-20" y="246" text-anchor="end" fill="#9bb0ff" font-size="12">20%</text>
            <text x="-20" y="306" text-anchor="end" fill="#9bb0ff" font-size="12">0%</text>
          </g>
        </g>
      </svg>
    </div>

    <!-- Controls Drawer -->
    <aside id="controlsDrawer" class="controls-drawer" aria-hidden="true">
      <div class="controls-panel card" role="dialog" aria-modal="true" aria-labelledby="controlsTitle">
        <button id="controlsClose" class="controls-close" aria-label="Close controls">×</button>

        <div id="ixaoq">
          <h1 id="controlsTitle">Controls</h1>
          <div class="sub">Click the valve in the visualization to open the interactive valve control. Use the button below for quick on/off toggle. Adjust outlet flow to drain the tank. Physics uses a simple mass balance dV/dt = Qin − Qout with a fixed cross-section area.</div>
          <div id="i3zec" class="controls">
            <div class="row">
              <button type="button" id="toggleValve" aria-pressed="false" class="btn toggle">Open Inlet Valve</button>
              <button type="button" id="resetBtn" class="btn">Reset</button>
              <button type="button" id="pauseBtn" aria-pressed="false" class="btn">Pause</button>
            </div>
            <div class="row">
              <label for="qout">Outlet flow</label>
              <input type="range" id="qout" min="0" max="1.2" step="0.01" value="0.35" class="grow"/>
              <output id="qoutVal">0.35</output>
            </div>
            <div class="row">
              <label for="qin">Inlet flow (max)</label>
              <input type="range" id="qin" min="0" max="1.5" step="0.01" value="0.80" class="grow"/>
              <output id="qinVal">0.80</output>
            </div>
            <div class="row">
              <label for="area">Tank area</label>
              <input type="range" id="area" min="0.5" max="3" step="0.01" value="1.20" class="grow"/>
              <output id="areaVal">1.20</output>
            </div>
            <div id="irdd2" class="kv">
              <div>Simulation step</div><div><span id="dtMs">16.7</span> ms (dynamic)</div>
              <div>Tank height (max)</div><div>360 px visual (normalized 1.0)</div>
              <div>Overflow limit</div><div id="overflowText">100%</div>
            </div>
            <p class="small">Tip: For a head-dependent drain, enable "Gravity mode" below. Then Qout = k·√(level). The slider sets k.</p>
            <div class="row">
              <label><input type="checkbox" id="gravityMode"/> Gravity mode</label>
              <input type="range" id="kcoeff" min="0" max="1.5" step="0.01" value="0.60" class="grow"/>
              <output id="kVal">0.60</output>
            </div>
          </div>

          <hr/>
          <h1>Readouts</h1>
          <div class="kv">
            <div>Level</div><div><span id="levelPct">0.0</span>%</div>
            <div>Volume</div><div><span id="vol">0.000</span> units</div>
            <div>Qin</div><div><span id="qinRead">0.00</span> units/s</div>
            <div>Qout</div><div><span id="qoutRead">0.35</span> units/s</div>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- INLET VALVE MODAL - Exact structure for all three -->
<div id="inletModal" class="valve-modal-overlay" aria-hidden="true">
  <div class="valve-modal-container">
    <button type="button" aria-label="Close inlet valve control" id="inletModalClose" class="valve-modal-close">×</button>
    <div class="valve-modal-title">Inlet Valve Control</div>
    <iframe id="inletValveIframe" src="valve.html" title="Inlet Valve Control"></iframe>
  </div>
</div>

<!-- OUTLET VALVE MODAL - Exact same structure -->
<div id="outletModal" class="valve-modal-overlay" aria-hidden="true">
  <div class="valve-modal-container">
    <button type="button" aria-label="Close outlet valve control" id="outletModalClose" class="valve-modal-close">×</button>
    <div class="valve-modal-title">Outlet Valve Control</div>
    <iframe id="outletValveIframe" src="valve.html" title="Outlet Valve Control"></iframe>
  </div>
</div>

<!-- PUMP MODAL - Exact same structure -->
<div id="pumpModal" class="valve-modal-overlay" aria-hidden="true">
  <div class="valve-modal-container">
    <button type="button" aria-label="Close pump control" id="pumpModalClose" class="valve-modal-close">×</button>
    <div class="valve-modal-title">Pump Control</div>
    <div class="row" style="gap:.5rem; margin-top:10px">
      <button type="button" id="pumpModalToggle" class="btn toggle" aria-pressed="true">
        Stop Pump
      </button>
    </div>
    <p class="small" style="margin-top:10px">
      Outlet flow appears only when the pump is ON and the outlet valve &gt; 0%.
    </p>
  </div>
</div>

</body>
</html>
