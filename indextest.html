<!DOCTYPE html>
<html lang="en">
<head>
  <title>Interactive Tank & Valve Simulator</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="./style.css">

  <style>
    /* grid + flow */
    .grid{ grid-template-columns: 1fr; }
    .flow { stroke-dasharray: 10 12; }
    .flow.on { animation: dash var(--duration, 600ms) linear infinite; }
    @keyframes dash { to { stroke-dashoffset: -22; } }

    /* Drawer + launcher styles (moved into <style>) */
    .controls-toggle{
      position: fixed; top: 12px; right: 12px; z-index: 1000;
      background:#172144; color:#e9f0ff; border:1px solid #28366d;
      padding:10px 14px; border-radius:12px; cursor:pointer;
    }
    .controls-toggle:active{ transform: translateY(1px); }

    .controls-drawer{
      position: fixed; inset: 0; z-index: 999;
      pointer-events: none; /* off until open */
    }
    .controls-drawer::before{
      content:""; position:absolute; inset:0; background: rgba(0,0,0,.35);
      opacity:0; transition: opacity .2s ease;
    }
    .controls-panel{
      position: absolute; top:0; right:0; height:100vh;
      width:min(420px, 92vw); background: var(--card, #121a33);
      border-left:1px solid #1f2a50; box-shadow: -20px 0 50px rgba(0,0,0,.4);
      transform: translateX(100%); transition: transform .25s ease;
      overflow:auto; padding:16px; color: var(--ink, #e9f0ff);
    }
    .controls-close{
      position: sticky; top:0; float:right; margin:-6px -6px 8px 8px;
      background:transparent; color:var(--ink, #e9f0ff); border:1px solid #28366d;
      border-radius:10px; padding:6px 10px; cursor:pointer; font-size:20px;
    }
    .controls-drawer.open{ pointer-events: auto; }
    .controls-drawer.open::before{ opacity:1; }
    .controls-drawer.open .controls-panel{ transform: translateX(0); }

/* Pump: clickable image; show pointer cursor */
#pump image { pointer-events: all; }
#pump { cursor: pointer; }

/* Valves: only the hitbox is clickable; image/labels ignore clicks */
.valve image,
.valve text { pointer-events: none; }
.valve .valve-hitbox { pointer-events: auto; cursor: pointer; }

.ctrl-section[hidden]{ display:none; }

/* --- Popout window (shared by inlet/outlet/pump) --- */
:root{
  --modal-w: min(560px, 92vw);
  --modal-h: min(420px, 88vh);
  --ink: #e9f0ff;
  --panel: #0f1731;
  --edge: #14d9e8;    /* cyan accent */
  --danger: #EC4437;  /* red close */
}

.valve-modal-overlay{
  position: fixed; inset: 0; display: none;
  align-items: center; justify-content: center;
  background: rgba(0,0,0,.55); z-index: 1002;
}
.valve-modal-overlay.open{ display: flex; }

.valve-modal-container{
  width: var(--modal-w);
  max-height: var(--modal-h);
  background: var(--panel); color: var(--ink);
  border: 1px solid #1f2a50; border-radius: 14px;
  box-shadow: 0 20px 60px rgba(0,0,0,.6);
  overflow: hidden;                 /* no inner scrollbars */
  display: grid; grid-template-rows: auto 1fr;
}

.modal-header{
  display:flex; align-items:center; justify-content:space-between;
  padding: 10px 14px;
  background:#122046; border-bottom: 2px solid var(--edge);
  font-weight:700;
}
.modal-close{
  border:0; cursor:pointer;
  width:32px; height:32px; border-radius:50%;
  color:#fff; background: var(--danger); /* red button like your inlet */
}
.modal-close:hover{ filter: brightness(1.1); }

.modal-body{
  padding: 12px;
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;                 /* kill scrollbars */
}

/* iframes made tall enough to avoid scrollbars */
.modal-body iframe,
#inletValveIframe, /* fallback ids */
#outletValveIframe,
#ikt2sz{
  display:block; width:100%; height: 340px;
  border:0; border-radius:12px; background:#0e1734;
}

/* keep your other CSS fixes */
.ctrl-section[hidden]{ display:none; }


/* Segmented buttons for Pump ON/OFF */
.segmented{
  display:inline-flex; border:1px solid #28366d; border-radius:12px; overflow:hidden;
}
.segmented .seg-btn{
  background:#172144; color:var(--ink); border:0; padding:8px 16px; cursor:pointer;
}
.segmented .seg-btn.active{
  background:#1e2a55; box-shadow: inset 0 0 0 2px var(--edge);
}
.segmented .seg-btn:focus-visible{ outline:2px solid var(--edge); outline-offset:2px; }

/* (also fix your stray CSS comment) */
.ctrl-section[hidden]{ display:none; }



  </style>
</head>

  <body id="id13">

<button id="controlsToggle"
        class="controls-toggle"
        aria-controls="controlsDrawer"
        aria-expanded="false">
  Controls
</button>
  
    <div id="ie7wb" class="app">
      <div id="i4pt7" class="grid">
        <!-- LEFT: Visualization -->
        <div id="i3bwj" class="card stage">
          <svg viewBox="0 0 1000 600" aria-labelledby="title desc" role="img" id="iuele">
            <title id="title">Tank and Pipe Visualization</title>
            <desc id="desc">Click the inlet valve to open interactive valve control. Use the slider to adjust outlet flow. The blue rectangle shows the liquid level.</desc>
            <defs id="ic988">
              <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#22305f" stroke-width="1" id="iq7zz"></path>
              </pattern>
              <linearGradient id="liquid" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#7cc8ff" id="iuyo8"></stop>
                <stop offset="100%" stop-color="#2d8bd6" id="ijp66"></stop>
              </linearGradient>
            </defs>
            
<rect x="0" y="0" width="1000" height="600" fill="url(#grid)" opacity="0.4" id="ip0tv"></rect>
            

<g id="inlet">
  <path d="M 80 70 H 380 V 125" fill="none" stroke="#9bb0ff" stroke-width="20" stroke-linecap="round"></path>
  <path id="inletFlow" d="M 80 70 H 380 V 125" fill="none" stroke="#7cc8ff" stroke-width="8" stroke-linecap="round" class="flow"></path>

  <g id="valve" class="valve" tabindex="0" role="button" aria-pressed="false" aria-label="Open valve control">
    <!-- Everything that should move together lives inside this translated group -->
    <g transform="translate(230, 53)">
      <!-- Click target -->
      <rect class="valve-hitbox" x="-50" y="-50" width="125" height="125" fill="transparent" stroke="none"/>

      <!-- Icon centered over hitbox (same centering as before) -->
      <image href="https://sco314.github.io/tank-sim/Valve-Icon-Transparent-bg.png"
             x="-38" y="-38" width="76" height="76" />

      <!-- Hide Labels belong inside the same transform 
      <text x="1" y="55" fill="#9bb0ff" font-size="13" text-anchor="middle" font-weight="600" pointer-events="none">Inlet Valve</text>
      <text x="1" y="70" fill="#7cc8ff" font-size="10" text-anchor="middle" pointer-events="none">(click to control)</text>-->
    </g>
  </g>
</g>   
           
<!-- OUTLET (continuous; runs under pump, then up, then right) -->
<g id="outlet">
  <!-- Base pipe -->
  <path id="outletPipe"
        d="M 660 460 H 815 V 295 H 960"
        fill="none" stroke="#9bb0ff" stroke-width="20"
        stroke-linecap="round" stroke-linejoin="round"/>

  <!-- Flow overlay (same geometry) -->
  <path id="outletFlow"
        d="M 660 460 H 815 V 295 H 960"
        fill="none" stroke="#7cc8ff" stroke-width="8"
        stroke-linecap="round" stroke-linejoin="round"
        class="flow"/>
</g>

<!-- PUMP  -->
<g id="pump" class="pump" transform="translate(790,460)" tabindex="0" role="button" aria-pressed="true" aria-label="Toggle pump">
  <image href="https://sco314.github.io/tank-sim/cent-pump-9-inlet-left.png" x="-20" y="-130" width="230" height="230" />
  <!-- centered under the 230×230 image: mid ≈ 95 -->
  <!-- Hide Labels <text x="135" y="85" fill="#9bb0ff" font-size="13" text-anchor="middle" font-weight="600" pointer-events="none">Outlet Pump</text>
   <text x="135" y="100" fill="#7cc8ff" font-size="10" text-anchor="middle" pointer-events="none">(click to toggle)</text> -->
</g>

<!-- OUTLET VALVE -->
<g id="outletValve" class="valve" aria-label="Open outlet valve">
  <g transform="translate(890,278)">
    <!-- debug dot: shows the group's origin; remove when happy -->
    
    <rect class="valve-hitbox" x="-50" y="-50" width="125" height="125"
          fill="transparent" stroke="none" tabindex="0" role="button" aria-pressed="true" />

    <!-- icon centered on the hitbox -->
    <image href="https://sco314.github.io/tank-sim/Valve-Icon-Transparent-bg.png"
           x="-38" y="-38" width="76" height="76" />
  </g>
</g>


		  
            <g id="tank" transform="translate(340, 120)">
              <rect x="0" y="0" width="320" height="360" rx="18" fill="#0e1734" stroke="#2a3d78" stroke-width="4" id="i85h9"></rect>
              <rect id="levelRect" x="6" y="360" width="308" height="0" fill="url(#liquid)" class="levelRect"></rect>
              <g id="ticks" stroke="#334a90">
                <path d="M0 60 h-14 M0 120 h-14 M0 180 h-14 M0 240 h-14 M0 300 h-14" id="ikm1h"></path>
                <text x="-20" y="66" text-anchor="end" fill="#9bb0ff" font-size="12" id="ir428">80%</text>
                <text x="-20" y="126" text-anchor="end" fill="#9bb0ff" font-size="12" id="ibiaf">60%</text>
                <text x="-20" y="186" text-anchor="end" fill="#9bb0ff" font-size="12" id="irb4x">40%</text>
                <text x="-20" y="246" text-anchor="end" fill="#9bb0ff" font-size="12" id="imc0k">20%</text>
                <text x="-20" y="306" text-anchor="end" fill="#9bb0ff" font-size="12" id="i4a8a">0%</text>
              </g>
            </svg>
        </div>

        
<!-- Controls Drawer (hidden by default) -->
<aside id="controlsDrawer" class="controls-drawer" aria-hidden="true">
  <div class="controls-panel card" role="dialog" aria-modal="true" aria-labelledby="controlsTitle">
    <button id="controlsClose" class="controls-close" aria-label="Close controls">×</button>

    <!-- Keep your existing content here (unchanged) -->
    <div id="ixaoq">
      <h1 id="controlsTitle">Controls</h1>
      <div class="sub">Click the valve in the visualization to open the interactive valve control. Use the button below for quick on/off toggle. Adjust outlet flow to drain the tank. Physics uses a simple mass balance dV/dt = Qin − Qout with a fixed cross-section area.</div>
      <div id="i3zec" class="controls">
        <div class="row">
          <button type="button" id="toggleValve" aria-pressed="false" class="btn toggle">Open Inlet Valve</button>
          <button type="button" id="resetBtn" class="btn">Reset</button>
          <button type="button" id="pauseBtn" aria-pressed="false" class="btn">Pause</button>
        </div>
        <div class="row">
          <label for="qout" id="i8u9j">Outlet flow</label>
          <input type="range" id="qout" min="0" max="1.2" step="0.01" value="0.35" class="grow"/>
          <output id="qoutVal">0.35</output>
        </div>
        <div class="row">
          <label for="qin" id="id1ii">Inlet flow (max)</label>
          <input type="range" id="qin" min="0" max="1.5" step="0.01" value="0.80" class="grow"/>
          <output id="qinVal">0.80</output>
        </div>
        <div class="row">
          <label for="area" id="iiezj">Tank area</label>
          <input type="range" id="area" min="0.5" max="3" step="0.01" value="1.20" class="grow"/>
          <output id="areaVal">1.20</output>
        </div>
        <div id="irdd2" class="kv">
          <div>Simulation step</div><div><span id="dtMs">16.7</span> ms (dynamic)</div>
          <div>Tank height (max)</div><div>360 px visual (normalized 1.0)</div>
          <div>Overflow limit</div><div id="overflowText">100%</div>
        </div>
        <p id="iaxfc5" class="small">Tip: For a head-dependent drain, enable "Gravity mode" below. Then Qout = k·√(level). The slider sets k.</p>
        <div class="row">
          <label><input type="checkbox" id="gravityMode"/> Gravity mode</label>
          <input type="range" id="kcoeff" min="0" max="1.5" step="0.01" value="0.60" class="grow"/>
          <output id="kVal">0.60</output>
        </div>
      </div>

<!-- ==== PUMP PANEL (drawer "popout") ==== -->
<section id="ctrl-pump" class="ctrl-section" hidden>
  <h2 style="margin-top:0">Pump</h2>
  <p class="small">Starts flow from the tank to the outlet valve. Flow appears only when the outlet valve is open.</p>
  <div class="row">
    <button type="button" id="pumpToggleBtn" class="btn toggle" aria-pressed="true">Stop Pump</button>
  </div>
</section>

      <hr id="ir0ydi"/>
      <h1>Readouts</h1>
      <div class="kv">
        <div>Level</div><div><span id="levelPct">0.0</span>%</div>
        <div>Volume</div><div><span id="vol">0.000</span> units</div>
        <div>Qin</div><div><span id="qinRead">0.00</span> units/s</div>
        <div>Qout</div><div><span id="qoutRead">0.35</span> units/s</div>
      </div>
    </div>
  </div>
</aside>

    <!-- Load organized JavaScript -->
    <script src="js/ValvePopup.js"></script>
    <script src="js/TankSimulation.js"></script>

    <!-- Test popup function -->
    <script>
      function testPopup() {
        console.log('Test button clicked');
        if (window.simulation && window.simulation.valvePopup) {
          console.log('Using simulation popup...');
          window.simulation._openValvePopup();
        } else if (window.ValvePopup) {
          console.log('ValvePopup found, creating new instance...');
          const popup = new ValvePopup((value) => console.log('Valve value:', value));
          popup.open(0.5);
        } else {
          console.error('ValvePopup.js not loaded!');
          alert('ValvePopup.js failed to load. Check the console for errors.');
        }
      }
    </script>

<!-- ===== INLET VALVE POPOUT  ===== -->
<div id="inletModal" class="valve-modal-overlay" aria-hidden="true">
  <div class="valve-modal-container">
    <div class="modal-header">
      <div>Inlet Valve Control</div>
      <button type="button" id="inletModalClose" class="modal-close" aria-label="Close">×</button>
    </div>
    <div class="modal-body">
      <iframe id="inletValveIframe"
              src="valve.html"
              title="Inlet Valve Control"></iframe>
    </div>
  </div>
</div>


<!-- ===== OUTLET VALVE POPOUT  ===== -->
<div id="outletModal" class="valve-modal-overlay" aria-hidden="true">
  <div class="valve-modal-container">
    <div class="modal-header">
      <div>Outlet Valve Control</div>
      <button id="outletModalClose" class="modal-close" aria-label="Close">×</button>
    </div>
    <div class="modal-body">
      <iframe id="outletValveIframe"
              src="valve.html#outlet"
              title="Outlet Valve Control"></iframe>
    </div>
  </div>
</div>



<!-- ===== PUMP POPOUT ===== -->
<div id="pumpModal" class="valve-modal-overlay" aria-hidden="true">
  <div class="valve-modal-container">
    <div class="modal-header">
      <div>Pump Control</div>
      <button id="pumpModalClose" class="modal-close" aria-label="Close">×</button>
    </div>
    <div class="modal-body">
      <div class="segmented" role="group" aria-label="Pump power">
        <button id="pumpOnBtn"  class="seg-btn" aria-pressed="true">On</button>
        <button id="pumpOffBtn" class="seg-btn" aria-pressed="false">Off</button>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    const drawer   = document.getElementById('controlsDrawer');
    const panel    = drawer.querySelector('.controls-panel');
    const toggle   = document.getElementById('controlsToggle');
    const closeBtn = document.getElementById('controlsClose');

    function openDrawer(){
      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden','false');
      toggle.setAttribute('aria-expanded','true');
      // move focus into the drawer
      setTimeout(() => closeBtn.focus(), 0);
    }
    function closeDrawer(){
      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden','true');
      toggle.setAttribute('aria-expanded','false');
      toggle.focus();
    }

    // Clicks
    toggle.addEventListener('click', openDrawer);
    closeBtn.addEventListener('click', closeDrawer);
    // Click on backdrop closes (ignore clicks inside panel)
    drawer.addEventListener('click', (e) => {
      if (!panel.contains(e.target)) closeDrawer();
    });
    // ESC closes
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && drawer.classList.contains('open')) closeDrawer();
    });
  })();
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Try a few selectors in case IDs drift
  const valveEl = document.querySelector('#valve, g#valve, [data-role="inlet-valve"]');
  const toggleBtn = document.querySelector('#toggleValve, button#toggleValve');
  const inletFlow = document.getElementById('inletFlow');

  if (!valveEl)  console.warn('Valve wiring: inlet valve SVG not found (expected #valve).');
  if (!toggleBtn) console.warn('Valve wiring: right-panel toggle button not found (expected #toggleValve).');
  if (!inletFlow) console.warn('Valve wiring: inlet flow path not found (expected #inletFlow).');

  if (!valveEl || !toggleBtn) return; // can't bind

  function isValveOpenFromButton() {
    const pressed = toggleBtn.getAttribute('aria-pressed');
    if (pressed === 'true')  return true;
    if (pressed === 'false') return false;
    return /close/i.test(toggleBtn.textContent || ''); // fallback by label
  }

  function syncInletFlow() {
    inletFlow?.classList.toggle('on', isValveOpenFromButton());
  }

  function toggleFromGraphic() {
    toggleBtn.click();   // reuse your existing sim logic
    syncInletFlow();     // keep visuals in sync immediately
  }

  valveEl.addEventListener('click', toggleFromGraphic);
  valveEl.addEventListener('keydown', e => {
    if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); toggleFromGraphic(); }
  });
  toggleBtn.addEventListener('click', syncInletFlow);

  // Initial sync on load
  syncInletFlow();

  console.info('Valve wiring bound:',
    { valveEl, toggleBtn, inletFlow, isOpen: isValveOpenFromButton() });
});
</script>
<script>

  // 2) Wire the SVG inlet valve to the existing right-panel button logic
  const valveEl   = document.querySelector('#valve, g#valve, [data-role="inlet-valve"]');
  const toggleBtn = document.querySelector('#toggleValve, button#toggleValve');
  const inletFlow = document.getElementById('inletFlow');

  function isValveOpenFromButton() {
    const pressed = toggleBtn?.getAttribute('aria-pressed');
    if (pressed === 'true')  return true;
    if (pressed === 'false') return false;
    return /close/i.test((toggleBtn?.textContent || '')); // fallback by label text
  }
  function syncInletFlow() {
    inletFlow?.classList.toggle('on', isValveOpenFromButton());
  }
  function toggleFromGraphic() {
    toggleBtn?.click();   // reuse your existing sim handler
    syncInletFlow();      // update dashed inlet immediately
  }

  if (!valveEl)  console.warn('Valve wiring: #valve not found.');
  if (!toggleBtn) console.warn('Valve wiring: #toggleValve not found.');
  if (valveEl && toggleBtn) {
    valveEl.addEventListener('click', toggleFromGraphic);
    valveEl.addEventListener('keydown', e => {
      if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); toggleFromGraphic(); }
    });
    toggleBtn.addEventListener('click', syncInletFlow);
    syncInletFlow(); // initial sync
  }

  // 3) Flash both flows for 2s to prove CSS/IDs are good
  const f1 = document.getElementById('inletFlow');
  const f2 = document.getElementById('outletFlow');
  f1?.classList.add('on'); f2?.classList.add('on');
  setTimeout(() => {
    // if we have the button wired, leave inlet following real state; else remove the flash
    if (toggleBtn) syncInletFlow(); else f1?.classList.remove('on');
  }, 2000);
})();
</script>

<script>
(() => {
  // ===== Click targets / elements =====
  const inletValveHit   = document.querySelector('#valve .valve-hitbox')  || document.getElementById('valve');
  const outletValveHit  = document.querySelector('#outletValve .valve-hitbox') || document.getElementById('outletValve');
  const pumpEl          = document.getElementById('pump');

  // Flow path for outlet (dashed overlay)
  const outletFlowPath  = document.getElementById('outletFlow');

  // Inlet popout
  const inletModal      = document.getElementById('inletModal');
  const inletClose      = document.getElementById('inletModalClose');
  const inletIframe     = document.getElementById('inletValveIframe');

  // Outlet popout
  const outletModal     = document.getElementById('outletModal');
  const outletClose     = document.getElementById('outletModalClose');
  const outletIframe    = document.getElementById('outletValveIframe');

  // Pump popout
  const pumpModal       = document.getElementById('pumpModal');
  const pumpClose       = document.getElementById('pumpModalClose');
  const pumpOnBtn       = document.getElementById('pumpOnBtn');
  const pumpOffBtn      = document.getElementById('pumpOffBtn');

  // ===== State =====
  let pumpOn = true;
  let outletValvePos = 1; // 0..1

  // ===== Modal helpers =====
  function openModal(el){
    el?.classList.add('open');
    el?.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }
  function closeModal(el){
    el?.classList.remove('open');
    el?.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }

  // Make valve iframes fit and push initial % so their “Open:XX%” shows immediately
  function fitAndInit(iframe, initialValue){
    if (!iframe) return;
    const send = () => {
      try {
        const doc = iframe.contentDocument || iframe.contentWindow?.document;
        const h = Math.max(
          doc?.documentElement?.scrollHeight || 0,
          doc?.body?.scrollHeight || 0,
          340
        );
        // prevent inner scrollbars
        iframe.style.height = Math.min(h, 360) + 'px';
      } catch(_) {}
      try { iframe.contentWindow?.postMessage({ type:'valve:set', value: initialValue }, '*'); } catch(_) {}
    };
    if (iframe.complete) { setTimeout(send, 0); }
    iframe.addEventListener('load', () => setTimeout(send, 0), { once:true });
  }

  // ===== Visuals =====
  function updateOutletVisual(){
    const flowing = pumpOn && outletValvePos > 0;
    outletFlowPath?.classList.toggle('on', flowing);
    if (outletFlowPath){
      const dur = 1200 - Math.round(800 * outletValvePos); // slower closed → faster open
      outletFlowPath.style.setProperty('--duration', dur + 'ms');
      outletFlowPath.style.opacity = flowing ? (0.25 + 0.75 * outletValvePos) : 0.15;
    }
  }

  // Keep pump UI pieces in sync (aria + segmented buttons)
  function updatePumpUI(){
    document.getElementById('pump')?.setAttribute('aria-pressed', String(pumpOn));
    if (pumpOnBtn && pumpOffBtn){
      pumpOnBtn.classList.toggle('active',  pumpOn);
      pumpOffBtn.classList.toggle('active', !pumpOn);
      pumpOnBtn.setAttribute('aria-pressed',  String(pumpOn));
      pumpOffBtn.setAttribute('aria-pressed', String(!pumpOn));
    }
  }

  // ===== Setters (single source of truth) =====
  function setPump(on){
    pumpOn = !!on;
    window.simulation?.setPumpFactor?.(pumpOn ? 1 : 0); // no-op if not provided
    updatePumpUI();          // ← IMPORTANT: highlight On/Off + aria
    updateOutletVisual();    // dashed outlet flow reflects pump state
  }

  function setOutletValve(pos){
    outletValvePos = Math.max(0, Math.min(1, pos));
    document.getElementById('outletValve')?.setAttribute('aria-pressed', String(outletValvePos > 0));
    window.simulation?.setOutletValve?.(outletValvePos); // supports partial open
    try { outletIframe?.contentWindow?.postMessage({ type:'valve:set', value: outletValvePos }, '*'); } catch(_) {}
    updateOutletVisual();
  }

  // ===== Inlet popout =====
  function openInlet(){
    openModal(inletModal);
    fitAndInit(inletIframe, 1); // inlet UI starts at 100% visually
    setTimeout(() => inletClose?.focus(), 0);
  }
  inletValveHit?.setAttribute('tabindex','0');
  inletValveHit?.setAttribute('role','button');
  inletValveHit?.addEventListener('click', openInlet);
  inletValveHit?.addEventListener('keydown', e => { if (e.key === ' ' || e.key === 'Enter'){ e.preventDefault(); openInlet(); }});
  inletClose?.addEventListener('click', () => closeModal(inletModal));
  inletModal?.addEventListener('click', (e) => { if (e.target === inletModal) closeModal(inletModal); });

  // ===== Outlet popout =====
  function openOutlet(){
    openModal(outletModal);
    fitAndInit(outletIframe, outletValvePos);
    setTimeout(() => outletClose?.focus(), 0);
  }
  outletValveHit?.setAttribute('tabindex','0');
  outletValveHit?.setAttribute('role','button');
  outletValveHit?.addEventListener('click', openOutlet);
  outletValveHit?.addEventListener('keydown', e => { if (e.key === ' ' || e.key === 'Enter'){ e.preventDefault(); openOutlet(); }});
  outletClose?.addEventListener('click', () => closeModal(outletModal));
  outletModal?.addEventListener('click', (e) => { if (e.target === outletModal) closeModal(outletModal); });

  // Only accept valve changes from the OUTLET iframe
  window.addEventListener('message', (e) => {
    if (!outletIframe || e.source !== outletIframe.contentWindow) return;
    const d = e.data;
    if (!d || d.type !== 'valve:changed') return;
    const pos = Math.max(0, Math.min(1, +d.value || 0));
    setOutletValve(pos);
  });

  // ===== Pump popout =====
  function openPump(){
    openModal(pumpModal);
    setTimeout(() => pumpClose?.focus(), 0);
  }
  pumpEl?.addEventListener('click', openPump);  // click opens popout
  pumpEl?.addEventListener('keydown', e => {    // space/enter = quick toggle
    if (e.key === ' ' || e.key === 'Enter'){ e.preventDefault(); setPump(!pumpOn); }
  });
  pumpClose?.addEventListener('click', () => closeModal(pumpModal));
  pumpModal?.addEventListener('click', (e) => { if (e.target === pumpModal) closeModal(pumpModal); });

  // segmented buttons inside pump popout
  pumpOnBtn?.addEventListener('click',  () => setPump(true));
  pumpOffBtn?.addEventListener('click', () => setPump(false));

  // ===== Init =====
  setPump(true);       // highlight “On”, set aria, update flow
  setOutletValve(1);   // 100% open
})();
</script>



  </body>
</html>
