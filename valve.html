<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OS&Y Gate Valve — Top View (Turns + Drag + Hold)</title>
<style>
  :root{
    --bg:#0b1330;
    --cyan:#1fd4d6;
    --metal:#8a9199;
    --dark:#4a5058;

    /* Model state */
    --open: 0;              /* 0..1 (fraction open) */
    --turns: 8;             /* total turns from shut to fully open */
    --cw-to-close: 1;       /* 1 = CW closes, CCW opens (common); -1 flips */

    /* Sizes */
    --R: 90;                /* wheel radius px (SVG space) */
    --gR: 104;              /* progress ring radius */
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:#c9d1d9;
    font:14px/1.4 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    display:grid; place-items:center;
  }
  .wrap{ position:relative; width:min(520px, 96vw); height:min(520px, 96vh); display:grid; place-items:center; }
  .valve{ position:relative; width:400px; aspect-ratio:1; }
  svg{ width:100%; height:100%; display:block; }

  /* Wheel rotation in 'turn' units for exact turns */
  .handwheel{
    transform-origin: 250px 250px;
    transform: rotate(calc(var(--cw-to-close) * var(--open) * var(--turns) * -1turn));
  }

  /* Progress ring */
  .progress{
    transform-origin: 250px 250px;
  }

  /* Buttons */
  .arrow-btn{
    position:absolute; top:50%; transform:translateY(-50%);
    width:96px; height:96px; border:0; background:transparent; cursor:pointer;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
  }
  .arrow-btn.left{ left:-120px; }
  .arrow-btn.right{ right:-120px; }
  .arrow-btn svg{ width:70px; height:70px; filter: drop-shadow(0 0 8px rgba(31,212,214,0.5)); }
  .arrow-btn .label{ margin-top:8px; color:var(--cyan); font-size:16px; font-weight:600; letter-spacing:.5px; text-transform:uppercase; }

  /* HUD chip */
  .hud{
    position:absolute; left:50%; bottom:-56px; transform:translateX(-50%);
    padding:.55rem 1rem; border-radius:999px; background:#1a2840; border:1px solid #2d3f5f;
    display:flex; gap:14px; align-items:center; white-space:nowrap;
  }
  .hud b{ color:#e7f6ff }

  /* Drag overlay */
  .drag-overlay{ position:absolute; inset:0; }
</style>
</head>
<body>
<div class="wrap">
  <div class="valve" id="valve">

    <!-- OPEN button -->
    <button class="arrow-btn left" id="btnOpen" aria-label="Open valve">
      <svg viewBox="0 0 100 100" fill="none" aria-hidden="true">
        <path d="M 70 20 A 30 30 0 1 0 70 80" stroke="var(--cyan)" stroke-width="7" stroke-linecap="round"/>
        <polyline points="70,80 58,72 70,64" fill="none" stroke="var(--cyan)" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="label">Open</span>
    </button>

    <!-- CLOSE button -->
    <button class="arrow-btn right" id="btnClose" aria-label="Close valve">
      <svg viewBox="0 0 100 100" fill="none" aria-hidden="true">
        <path d="M 30 20 A 30 30 0 1 1 30 80" stroke="var(--cyan)" stroke-width="7" stroke-linecap="round"/>
        <polyline points="30,80 42,72 30,64" fill="none" stroke="var(--cyan)" stroke-width="7" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="label">Close</span>
    </button>

    <!-- Top-view valve -->
    <svg viewBox="0 0 500 500" aria-labelledby="title">
      <title id="title">Top view OS&amp;Y gate valve</title>
      <defs>
        <linearGradient id="metalGrad" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="#a8adb5"/><stop offset="50%" stop-color="#7a8088"/><stop offset="100%" stop-color="#5a6169"/>
        </linearGradient>
        <radialGradient id="bonnetGrad" cx="0.5" cy="0.5">
          <stop offset="0%" stop-color="#9fa5ad"/><stop offset="70%" stop-color="#7a8088"/><stop offset="100%" stop-color="#5a6169"/>
        </radialGradient>
      </defs>

      <!-- T body -->
      <g id="body">
        <rect x="30" y="220"  width="150" height="60" rx="8" fill="url(#metalGrad)" stroke="#4a5058" stroke-width="2"/>
        <rect x="320" y="220" width="150" height="60" rx="8" fill="url(#metalGrad)" stroke="#4a5058" stroke-width="2"/>
        <rect x="180" y="180" width="140" height="140" rx="12" fill="url(#metalGrad)" stroke="#4a5058" stroke-width="3"/>
        <circle cx="250" cy="250" r="85" fill="url(#bonnetGrad)" stroke="#4a5058" stroke-width="2"/>
        <circle cx="250" cy="250" r="75" fill="none" stroke="#3a4048" stroke-width="1"/>
      </g>

      <!-- Progress ring (under the wheel). We’ll control stroke-dashoffset in JS -->
      <g class="progress" aria-hidden="true">
        <circle id="progressTrack" cx="250" cy="250" r="104" fill="none" stroke="rgba(31,212,214,.12)" stroke-width="6"/>
        <circle id="progressArc"   cx="250" cy="250" r="104" fill="none" stroke="var(--cyan)" stroke-width="6"
                stroke-linecap="round" stroke-dasharray="0 1"/>
      </g>

      <!-- Wheel (rotates) -->
      <g class="handwheel">
        <circle cx="250" cy="250" r="90" fill="none" stroke="var(--cyan)" stroke-width="12"/>
        <!-- spoke trio -->
        <line x1="250" y1="250" x2="250" y2="162" stroke="var(--cyan)" stroke-width="10" stroke-linecap="round"/>
        <line x1="250" y1="250" x2="325" y2="292" stroke="var(--cyan)" stroke-width="10" stroke-linecap="round"/>
        <line x1="250" y1="250" x2="175" y2="292" stroke="var(--cyan)" stroke-width="10" stroke-linecap="round"/>
        <!-- hub -->
        <circle cx="250" cy="250" r="25" fill="url(#bonnetGrad)"/>
        <circle cx="250" cy="250" r="18" fill="#6b7179"/>
        <circle cx="250" cy="250" r="12" fill="#4a5058"/>
      </g>

      <!-- Fixed pointer (so you can sense rotation direction) -->
      <polygon points="250,118 244,134 256,134" fill="var(--cyan)" opacity=".8"/>
    </svg>

    <!-- Drag overlay so you can spin the wheel by hand -->
    <div class="drag-overlay" id="dragOverlay" aria-hidden="true"></div>

    <!-- HUD -->
    <div class="hud" aria-live="polite">
      <span>Open: <b id="pct">0%</b></span>
      <span>Turns: <b id="turns">0.0</b> / <b id="turnsMax">8</b></span>
    </div>
  </div>
</div>

<script>
(() => {
  const root   = document.documentElement;
  const pctEl  = document.getElementById('pct');
  const tEl    = document.getElementById('turns');
  const tMaxEl = document.getElementById('turnsMax');
  const btnOpen  = document.getElementById('btnOpen');
  const btnClose = document.getElementById('btnClose');
  const overlay  = document.getElementById('dragOverlay');

  const progressArc = document.getElementById('progressArc');

  // Config
  let TOTAL_TURNS = parseFloat(getComputedStyle(root).getPropertyValue('--turns')) || 8;
  tMaxEl.textContent = TOTAL_TURNS.toFixed(0);

  // Progress ring setup
  const R = 104; // must match SVG r
  const C = 2 * Math.PI * R;
  progressArc.setAttribute('stroke-dasharray', `${C} ${C}`);
  function setProgress(f){
    const off = C * (1 - f);
    progressArc.setAttribute('stroke-dashoffset', off);
  }

  function getOpen(){
    return parseFloat(getComputedStyle(root).getPropertyValue('--open')) || 0;
  }
  function setOpenFraction(f){
    f = Math.max(0, Math.min(1, f));
    root.style.setProperty('--open', f);
    pctEl.textContent = Math.round(f*100) + '%';
    tEl.textContent   = (f * TOTAL_TURNS).toFixed(1);
    setProgress(f);
    ValveTop._onChange?.(f); // callback for your sim if you want it
  }

  function animateTo(target, ms=900){
    const start = getOpen();
    const t0 = performance.now();
    function tick(t){
      const k = Math.min(1, (t - t0)/ms);
      const f = start + (target - start)*k;
      setOpenFraction(f);
      if(k<1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  // Hold-to-open/close (smooth)
  function hold(step){
    let raf = null, prev = performance.now();
    function loop(now){
      const dt = Math.min(64, now - prev); // ms clamp
      prev = now;
      const f = getOpen() + step * (dt/1000); // step is fraction/sec
      setOpenFraction(f);
      raf = requestAnimationFrame(loop);
    }
    raf = requestAnimationFrame(loop);
    return () => cancelAnimationFrame(raf);
  }
  let cancelHold = null;
  btnOpen.addEventListener('pointerdown', e => { e.preventDefault(); cancelHold?.(); cancelHold = hold(+0.5); });  // full travel ~2s
  btnClose.addEventListener('pointerdown', e => { e.preventDefault(); cancelHold?.(); cancelHold = hold(-0.5); });
  ['pointerup','pointercancel','pointerleave'].forEach(type => {
    btnOpen.addEventListener(type, () => { cancelHold?.(); cancelHold=null; });
    btnClose.addEventListener(type, () => { cancelHold?.(); cancelHold=null; });
  });

  // Click = step 1/2 turn
  btnOpen.addEventListener('click',  () => animateTo(Math.min(1, getOpen() + 0.5/TOTAL_TURNS), 250));
  btnClose.addEventListener('click', () => animateTo(Math.max(0, getOpen() - 0.5/TOTAL_TURNS), 250));

  // Drag the wheel to rotate
  overlay.addEventListener('pointerdown', onDragStart);
  function onDragStart(e){
    overlay.setPointerCapture(e.pointerId);
    const box = overlay.getBoundingClientRect();
    const cx = box.left + box.width/2;
    const cy = box.top  + box.height/2;
    let prevA = Math.atan2(e.clientY - cy, e.clientX - cx);
    let f = getOpen();

    function move(ev){
      const a = Math.atan2(ev.clientY - cy, ev.clientX - cx);
      let d = a - prevA;
      // wrap to [-pi, pi]
      if(d >  Math.PI) d -= 2*Math.PI;
      if(d < -Math.PI) d += 2*Math.PI;
      prevA = a;

      // Convert angle delta to fraction delta
      const dir = parseFloat(getComputedStyle(root).getPropertyValue('--cw-to-close')) || 1;
      f -= dir * d / (2*Math.PI) / TOTAL_TURNS; // CW closes
      setOpenFraction(f);
    }
    function end(ev){
      overlay.releasePointerCapture(e.pointerId);
      overlay.removeEventListener('pointermove', move);
      overlay.removeEventListener('pointerup', end);
      overlay.removeEventListener('pointercancel', end);
    }
    overlay.addEventListener('pointermove', move);
    overlay.addEventListener('pointerup', end);
    overlay.addEventListener('pointercancel', end);
  }

  // Keyboard: ← open, → close, Home shut, End open, Space toggle
  window.addEventListener('keydown', (e) => {
    if(['ArrowLeft','ArrowRight','Home','End',' '].includes(e.key)) e.preventDefault();
    const step = 1/TOTAL_TURNS; // one turn per keypress
    if(e.key==='ArrowLeft')  animateTo(Math.min(1, getOpen()+step), 120);
    if(e.key==='ArrowRight') animateTo(Math.max(0, getOpen()-step), 120);
    if(e.key==='Home') animateTo(0, 400);
    if(e.key==='End')  animateTo(1, 400);
    if(e.key===' ')    animateTo(getOpen()<0.5?1:0, 700);
  });

  // Expose a tiny API for Tank Sim
  window.ValveTop = {
    set: (f)=> setOpenFraction(f),
    open: ()=> animateTo(1, 900),
    close: ()=> animateTo(0, 900),
    onChange: (fn)=> (ValveTop._onChange = fn)
  };

  // init
  setOpenFraction(0);
})();
</script>
</body>
</html>
